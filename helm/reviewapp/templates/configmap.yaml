{{- if .Values.initScripts.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.initScripts.name }}
  namespace: {{ .Values.namespace.name }}
data:
  V1__Create_reviews_and_movie_ratings_tables.sql: |
    CREATE TABLE IF NOT EXISTS reviews (
        id BIGINT AUTO_INCREMENT PRIMARY KEY,
        movie_id BIGINT NOT NULL,
        user_name VARCHAR(100) NOT NULL,
        rating DECIMAL(2,1) NOT NULL CHECK (rating >= 1.0 AND rating <= 5.0),
        comment TEXT,
        review_date TIMESTAMP(6) DEFAULT CURRENT_TIMESTAMP(6),
        created_at TIMESTAMP(6) DEFAULT CURRENT_TIMESTAMP(6),
        updated_at TIMESTAMP(6) DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
        INDEX idx_movie_id (movie_id),
        INDEX idx_review_date (review_date),
        INDEX idx_rating (rating),
        INDEX idx_user_name (user_name)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

    CREATE TABLE IF NOT EXISTS movie_ratings (
        movie_id BIGINT PRIMARY KEY,
        average_rating DECIMAL(3,2),
        total_reviews INT DEFAULT 0,
        rating_1_count INT DEFAULT 0,
        rating_2_count INT DEFAULT 0,
        rating_3_count INT DEFAULT 0,
        rating_4_count INT DEFAULT 0,
        rating_5_count INT DEFAULT 0,
        last_updated TIMESTAMP(6) DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
        INDEX idx_average_rating (average_rating),
        INDEX idx_total_reviews (total_reviews)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
  V2__Insert_sample_reviews.sql: |
    INSERT INTO reviews (movie_id, user_name, rating, comment, review_date)
    SELECT 1, 'Alice Johnson', 5.0, 'Absolutely mind-blowing!', '2025-09-25 14:30:00'
    WHERE NOT EXISTS (
      SELECT 1 FROM reviews WHERE movie_id=1 AND user_name='Alice Johnson' AND review_date='2025-09-25 14:30:00'
    );
{{- end }}

